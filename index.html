<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambridge Assessment Scales (Interactive)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles */
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }

        /* Glossary Term Styling */
        .glossary-term {
            background-color: #fffbeb; /* Amber 50 */
            border-bottom: 2px solid #f59e0b; /* Amber 500 */
            color: #1e293b;
            cursor: help;
            border-radius: 2px;
            font-weight: 600;
            padding: 0 2px;
            transition: all 0.2s;
        }
        .glossary-term:hover {
            background-color: #fcd34d; /* Amber 300 */
            color: black;
        }

        /* Fixed Floating Tooltip (escapes scroll clipping) */
        #global-tooltip {
            position: fixed;
            display: none;
            background: #0f172a; /* Slate 900 */
            color: #f8fafc;
            padding: 12px 16px;
            border-radius: 6px;
            width: 300px;
            font-size: 12px;
            line-height: 1.5;
            z-index: 9999;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 0 0 1px #334155;
            pointer-events: none; /* Let mouse pass through */
        }

        /* Table adjustments */
        .rubric-table { table-layout: fixed; width: 100%; }
        .rubric-table th, .rubric-table td { word-wrap: break-word; overflow-wrap: break-word; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden text-xs">

    <!-- GLOBAL TOOLTIP CONTAINER -->
    <div id="global-tooltip"></div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 h-12 flex-none px-4 flex justify-between items-center shadow-sm z-30">
        <h1 class="font-bold text-slate-700 uppercase tracking-wide">Cambridge Writing Scales</h1>
        <div class="flex bg-slate-100 p-1 rounded-md text-[11px] font-medium">
            <button onclick="switchView('viewer')" id="btn-viewer" class="px-4 py-1.5 rounded shadow-sm bg-white text-slate-800 transition-all border border-slate-200">Rubric Viewer</button>
            <button onclick="switchView('compare')" id="btn-compare" class="px-4 py-1.5 rounded text-slate-500 hover:text-slate-800 transition-all">Comparator</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col h-full overflow-hidden relative">
        
        <!-- VIEW: Single Viewer -->
        <div id="view-viewer" class="flex flex-col h-full w-full">
            <div class="bg-white border-b border-slate-200 px-4 py-2 flex justify-between items-center flex-none">
                <div class="flex gap-1" id="level-tabs"></div>
                <button onclick="copyCurrentRubric()" class="flex items-center gap-1.5 text-[11px] bg-slate-50 hover:bg-slate-100 border border-slate-200 px-3 py-1.5 rounded text-slate-700 transition-colors font-medium">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    Copy Markdown
                </button>
            </div>
            <div class="flex-grow overflow-auto p-4 custom-scroll">
                <div id="rubric-display" class="bg-white shadow-sm border border-slate-300 rounded-lg overflow-hidden"></div>
            </div>
        </div>

        <!-- VIEW: Comparator -->
        <div id="view-compare" class="hidden flex flex-col h-full w-full">
            <div class="bg-white border-b border-slate-200 px-4 py-3 flex flex-col gap-3 flex-none shadow-[0_2px_4px_rgba(0,0,0,0.02)] z-20">
                <div class="flex items-center gap-3">
                    <span class="font-bold text-slate-400 w-16 text-[10px] uppercase tracking-wider text-right">Levels</span>
                    <div class="flex gap-2" id="compare-level-checks"></div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-bold text-slate-400 w-16 text-[10px] uppercase tracking-wider text-right">Subscales</span>
                    <div class="flex flex-wrap gap-2" id="compare-subscale-checks"></div>
                </div>
            </div>
            <div class="flex-grow overflow-auto bg-slate-50 p-2 custom-scroll">
                <div id="comparison-result" class="min-w-full"></div>
            </div>
        </div>
    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-16 right-5 bg-slate-800 text-white px-4 py-3 rounded-md shadow-lg opacity-0 transition-all duration-300 pointer-events-none transform translate-y-2 font-medium z-50">
        Markdown copied to clipboard
    </div>

    <script>
        // --- REGEX HELPER ---
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // --- DATA OBJECTS (Verbatim) ---
        const DB = {
            "A2": {
                subscales: ["CONTENT", "ORGANISATION", "LANGUAGE"],
                glossary: {
                    "Target reader": "the intended recipient of a piece of writing. It is important to ensure that the effect of a written task on a target reader is a positive one.",
                    "Coherence": "language which is coherent is well planned and clear, and all the parts or ideas fit well so that they form a united whole.",
                    "Cohesive devices": "words or phrases which indicate relationships between utterances, e.g. addition (and, in addition, moreover); consequence (so, therefore, as a result); order of information (first, second, next, finally).",
                    "Lexical": "adjective from lexis, meaning to do with vocabulary.",
                    "Appropriacy of vocabulary": "the use of words and phrases that fit the context of the given task.",
                    "Grammatical control": "the ability to consistently use grammar accurately and appropriately to convey intended meaning.",
                    "Simple grammatical forms": "words, phrases, basic tenses and simple clauses.",
                    "Complex grammatical forms": "longer and more complex utterances, e.g. noun clauses, relative and adverb clauses, subordination, passive forms, infinitives, verb patterns, modal forms and tense contrasts."
                },
                bands: {
                    5: { CONTENT: "All content is relevant to the task. Target reader is fully informed.", ORGANISATION: "Text is connected and coherent, using basic linking words and a limited number of cohesive devices.", LANGUAGE: "Uses everyday vocabulary generally appropriately, while occasionally overusing certain lexis. Uses simple grammatical forms with a good degree of control. While errors are noticeable, meaning can still be determined." },
                    3: { CONTENT: "Minor irrelevances and/or omissions may be present. Target reader is on the whole informed.", ORGANISATION: "Text is connected using basic, high-frequency linking words.", LANGUAGE: "Uses basic vocabulary reasonably appropriately. Uses simple grammatical forms with some degree of control. Errors may impede meaning at times." },
                    1: { CONTENT: "Irrelevances and misinterpretation of task may be present. Target reader is minimally informed.", ORGANISATION: "Production unlikely to be connected, though punctuation and simple connectors (i.e. ‘and’) may on occasion be used.", LANGUAGE: "Produces basic vocabulary of isolated words and phrases. Produces few simple grammatical forms with only limited control." }
                }
            },
            "B1": {
                subscales: ["Content", "Communicative Achievement", "Organisation", "Language"],
                glossary: {
                    "Target reader": "Who would read this text? (For example: the readers of a magazine, or the writer’s English teacher.)",
                    "Information requirements": "Would the reader have all the information they need? The task always tells the candidate what information to include.",
                    "Conventions of the communicative task": "These include genre, format, register and function. For example, a personal letter should not look like a formal report, and an email to a teacher would probably be more formal and polite than an email to a close friend!",
                    "Straightforward ideas": "These are usually concrete, limited in subject and are communicated with relatively simple style, words and grammar.",
                    "Hold the target reader’s attention": "This is a good thing! It means the reader is interested, not distracted, and it’s not difficult for the reader to make sense of the text.",
                    "Simple ideas": "These typically require only one or a few words to communicate. For example, I like pop music or Let’s go next week.",
                    "Cohesive devices": "Linking words are one type of cohesive device, but cohesive devices include other words and phrases that connect ideas and words within a text.",
                    "High-frequency linking words": "High-frequency linking words include and, so, because, first of all and so on.",
                    "Coherent": "Easy to understand because the ideas and sentences are well connected.",
                    "Basic linking words": "Basic linking words show an explicit connection between ideas and sentences. These include for example, because, finally and so on.",
                    "Everyday vocabulary": "Everyday vocabulary means words or phrases that are used often in the context mentioned in the task.",
                    "Less common lexis": "Less common lexis is vocabulary which is understandable but not often used in this context, such as gourmet food or seating arrangements.",
                    "Grammatical control": "This means the writer seems to be in control of their grammar – they are not making lucky guesses!",
                    "Appropriate vocabulary": "Vocabulary is appropriate when it fits the context of the task and the other words around it.",
                    "Basic vocabulary": "This is the kind of vocabulary you need for basic survival – simple transactions, for example.",
                    "Errors do not impede communication": "Big snow is a good example of an error which does not impede communication."
                },
                bands: {
                    5: { Content: "All content is relevant to the task. Target reader is fully informed.", "Communicative Achievement": "Uses the conventions of the communicative task to hold the target reader’s attention and communicate straightforward ideas.", Organisation: "Text is generally well organised and coherent, using a variety of linking words and cohesive devices.", Language: "Uses a range of everyday vocabulary appropriately, with occasional inappropriate use of less common lexis. Uses a range of simple and some complex grammatical forms with a good degree of control. Errors do not impede communication." },
                    3: { Content: "Minor irrelevances and/or omissions may be present. Target reader is on the whole informed.", "Communicative Achievement": "Uses the conventions of the communicative task in generally appropriate ways to communicate straightforward ideas.", Organisation: "Text is connected and coherent, using basic linking words and a limited number of cohesive devices.", Language: "Uses everyday vocabulary generally appropriately, while occasionally overusing certain lexis. Uses simple grammatical forms with a good degree of control. While errors are noticeable, meaning can still be determined." },
                    1: { Content: "Irrelevances and misinterpretation of task may be present. Target reader is minimally informed.", "Communicative Achievement": "Produces text that communicates simple ideas in simple ways.", Organisation: "Text is connected using basic, high-frequency linking words.", Language: "Uses basic vocabulary reasonably appropriately. Uses simple grammatical forms with some degree of control. Errors may impede meaning at times." }
                }
            },
            "B2": {
                subscales: ["CONTENT", "COMMUNICATIVE ACHIEVEMENT", "ORGANISATION", "LANGUAGE"],
                glossary: {
                    "Generally": "Generally is a qualifier meaning not in every way or instance. Thus, generally appropriately refers to performance that is not as good as ‘appropriately’.",
                    "Flexibility": "Flexible and flexibly refer to the ability to adapt – whether language, organisational devices, or task conventions.",
                    "Relevant": "Relevant means related or relatable to required content points and/or task requirements.",
                    "Target reader": "The target reader is the hypothetical reader set up in the task, e.g. a magazine’s readership, your English teacher.",
                    "Informed": "The target reader is informed if content points and/or task requirements are addressed and appropriately developed.",
                    "Conventions of the communicative task": "Conventions of the communicative task include such things as genre, format, register and function.",
                    "Holding the target reader’s attention": "Holding the target reader’s attention is used in the positive sense and refers to the quality of a text that allows a reader to derive meaning and not be distracted.",
                    "Communicative purpose": "Communicative purpose refers to the communicative requirements as set out in the task, e.g. make a complaint, suggest alternatives.",
                    "Straightforward and complex ideas": "Straightforward ideas are those which relate to relatively limited subject matter, usually concrete in nature. Complex ideas are those which are of a more abstract nature.",
                    "Linking words": "Linking words are cohesive devices, but are separated here to refer to higher-frequency vocabulary which provides explicit linkage.",
                    "Cohesive devices": "Cohesive devices refers to more sophisticated linking words and phrases (e.g. moreover, it may appear, as a result), as well as grammatical devices.",
                    "Organisational patterns": "Organisational patterns refers to less-explicit ways of achieving connection at the between-sentence level and beyond.",
                    "Basic vocabulary": "Basic vocabulary refers to vocabulary used for survival purposes, for simple transactions, and the like.",
                    "Everyday vocabulary": "Everyday vocabulary refers to vocabulary that comes up in common situations of a non-technical nature in the relevant domain.",
                    "Less common lexis": "Less common lexis refers to vocabulary items that appear less often in the relevant domain.",
                    "Appropriacy of vocabulary": "Appropriacy of vocabulary: the use of words and phrases that fit the context of the given task.",
                    "Simple grammatical forms": "Simple grammatical forms: words, phrases, basic tenses and simple clauses.",
                    "Complex grammatical forms": "Complex grammatical forms: longer and more complex items, e.g. noun clauses, relative and adverb clauses.",
                    "Grammatical control": "Grammatical control: the ability to consistently use grammar accurately and appropriately to convey intended meaning.",
                    "Range": "Range: the variety of words and grammatical forms a candidate uses.",
                    "Overuse": "Overuse refers to those cases where candidates repeatedly use the same word because they do not have the resources to use another term or phrase.",
                    "Errors and slips": "Errors are systematic mistakes. Slips are mistakes that are non-systematic.",
                    "Impede communication": "Impede communication means getting in the way of meaning."
                },
                bands: {
                    5: { CONTENT: "All content is relevant to the task. Target reader is fully informed.", "COMMUNICATIVE ACHIEVEMENT": "Uses the conventions of the communicative task effectively to hold the target reader’s attention and communicate straightforward and complex ideas, as appropriate.", ORGANISATION: "Text is well organised and coherent, using a variety of cohesive devices and organisational patterns to generally good effect.", LANGUAGE: "Uses a range of vocabulary, including less common lexis, appropriately. Uses a range of simple and complex grammatical forms with control and flexibility. Occasional errors may be present but do not impede communication." },
                    3: { CONTENT: "Minor irrelevances and/or omissions may be present. Target reader is on the whole informed.", "COMMUNICATIVE ACHIEVEMENT": "Uses the conventions of the communicative task to hold the target reader’s attention and communicate straightforward ideas.", ORGANISATION: "Text is generally well organised and coherent, using a variety of linking words and cohesive devices.", LANGUAGE: "Uses a range of everyday vocabulary appropriately, with occasional inappropriate use of less common lexis. Uses a range of simple and some complex grammatical forms with a good degree of control. Errors do not impede communication." },
                    1: { CONTENT: "Irrelevances and misinterpretation of task may be present. Target reader is minimally informed.", "COMMUNICATIVE ACHIEVEMENT": "Uses the conventions of the communicative task in generally appropriate ways to communicate straightforward ideas.", ORGANISATION: "Text is connected and coherent, using basic linking words and a limited number of cohesive devices.", LANGUAGE: "Uses everyday vocabulary generally appropriately, while occasionally overusing certain lexis. Uses simple grammatical forms with a good degree of control. While errors are noticeable, meaning can still be determined." }
                }
            },
            "C1": { subscales: ["CONTENT", "COMMUNICATIVE ACHIEVEMENT", "ORGANISATION", "LANGUAGE"], glossary: {}, bands: {} },
            "C2": { subscales: ["CONTENT", "COMMUNICATIVE ACHIEVEMENT", "ORGANISATION", "LANGUAGE"], glossary: {}, bands: {} }
        };

        // --- INHERITANCE LOGIC ---
        // Copy B2 glossary/bands structure to C1/C2 but use C1/C2 texts from prompt
        // NOTE: For brevity in this fix, I am re-populating C1/C2 glossary with B2 as standard practice 
        // unless you strictly want empty glossaries if not explicitly in C1 table?
        // The prompt C1/C2 tables in your message actually LIST the same glossary terms (Context, Target Reader etc).
        // I will copy B2 glossary object to C1/C2 to ensure functionality works for those levels.
        DB.C1.glossary = {...DB.B2.glossary};
        DB.C2.glossary = {...DB.B2.glossary};

        // Populate C1 Bands (Verbatim)
        DB.C1.bands = {
            5: { CONTENT: "All content is relevant to the task. Target reader is fully informed.", "COMMUNICATIVE ACHIEVEMENT": "Uses the conventions of the communicative task with sufficient flexibility to communicate complex ideas in an effective way, holding the target reader’s attention with ease, fulfilling all communicative purposes.", ORGANISATION: "Text is a well-organised, coherent whole, using a variety of cohesive devices and organisational patterns with flexibility.", LANGUAGE: "Uses a range of vocabulary, including less common lexis, effectively and precisely. Uses a wide range of simple and complex grammatical forms with full control, flexibility and sophistication. Occasional errors may be present but do not impede communication." },
            3: { CONTENT: "Minor irrelevances and/or omissions may be present. Target reader is on the whole informed.", "COMMUNICATIVE ACHIEVEMENT": "Uses the conventions of the communicative task effectively to hold the target reader’s attention and communicate straightforward and complex ideas, as appropriate.", ORGANISATION: "Text is well organised and coherent, using a variety of cohesive devices and organisational patterns to generally good effect.", LANGUAGE: "Uses a range of vocabulary, including less common lexis, appropriately. Uses a range of simple and complex grammatical forms with control and flexibility. Occasional errors may be present but do not impede communication." },
            1: { CONTENT: "Irrelevances and misinterpretation of task may be present. Target reader is minimally informed.", "COMMUNICATIVE ACHIEVEMENT": "Uses the conventions of the communicative task to hold the target reader’s attention and communicate straightforward ideas.", ORGANISATION: "Text is generally well organised and coherent, using a variety of linking words and cohesive devices.", LANGUAGE: "Uses a range of everyday vocabulary appropriately, with occasional inappropriate use of less common lexis. Uses a range of simple and some complex grammatical forms with a good degree of control. Errors do not impede communication." }
        };

        // Populate C2 Bands (Verbatim)
        DB.C2.bands = {
            5: { CONTENT: "All content is relevant to the task. Target reader is fully informed.", "COMMUNICATIVE ACHIEVEMENT": "Demonstrates complete command of the conventions of the communicative task. Communicates complex ideas in an effective and convincing way, holding the target reader’s attention with ease, fulfilling all communicative purposes.", ORGANISATION: "Text is organised impressively and coherently using a wide range of cohesive devices and organisational patterns with complete flexibility.", LANGUAGE: "Uses a wide range of vocabulary, including less common lexis, with fluency, precision, sophistication and style. Use of grammar is sophisticated, fully controlled and completely natural. Any inaccuracies occur only as slips." },
            3: { CONTENT: "Minor irrelevances and/or omissions may be present. Target reader is on the whole informed.", "COMMUNICATIVE ACHIEVEMENT": "Uses the conventions of the communicative task with sufficient flexibility to communicate complex ideas in an effective way, holding the target reader’s attention with ease, fulfilling all communicative purposes.", ORGANISATION: "Text is a well-organised, coherent whole, using a variety of cohesive devices and organisational patterns with flexibility.", LANGUAGE: "Uses a range of vocabulary, including less common lexis, effectively and precisely. Uses a wide range of simple and complex grammatical forms with full control, flexibility and sophistication. Errors, if present, are related to less common words and structures, or occur as slips." },
            1: { CONTENT: "Irrelevances and misinterpretation of task may be present. Target reader is minimally informed.", "COMMUNICATIVE ACHIEVEMENT": "Uses the conventions of the communicative task effectively to hold the target reader’s attention and communicate straightforward and complex ideas, as appropriate.", ORGANISATION: "Text is well organised and coherent, using a variety of cohesive devices and organisational patterns to generally good effect.", LANGUAGE: "Uses a range of vocabulary, including less common lexis, appropriately. Uses a range of simple and complex grammatical forms with control and flexibility. Occasional errors may be present but do not impede communication." }
        };

        const LEVELS = ["A2", "B1", "B2", "C1", "C2"];
        const LEVEL_STYLES = {
            "A2": { bg: "bg-teal-50", header: "bg-teal-700" },
            "B1": { bg: "bg-emerald-50", header: "bg-emerald-700" },
            "B2": { bg: "bg-sky-50", header: "bg-sky-700" },
            "C1": { bg: "bg-violet-50", header: "bg-violet-700" },
            "C2": { bg: "bg-fuchsia-50", header: "bg-fuchsia-700" }
        };

        let currentLevel = "B2";

        // --- APP LOGIC ---
        function init() {
            renderTabs();
            renderRubric(currentLevel);
            renderComparatorControls();
            runComparison();
            setupTooltipSystem();
        }

        // --- TOOLTIP SYSTEM ---
        // Solves the clipping issue by using a fixed position div
        function setupTooltipSystem() {
            const tooltip = document.getElementById('global-tooltip');
            let activeTerm = null;

            // Use event delegation for performance and dynamic content
            document.body.addEventListener('mouseover', (e) => {
                if (e.target.classList.contains('glossary-term')) {
                    activeTerm = e.target;
                    tooltip.innerHTML = e.target.getAttribute('data-definition');
                    tooltip.style.display = 'block';
                    positionTooltip(e.target, tooltip);
                }
            });

            document.body.addEventListener('mouseout', (e) => {
                if (e.target.classList.contains('glossary-term')) {
                    tooltip.style.display = 'none';
                    activeTerm = null;
                }
            });

            // Update position on scroll to keep it attached if we wanted, 
            // but hiding on scroll is often cleaner. For now, we hide on mouseout.
        }

        function positionTooltip(target, tooltip) {
            const rect = target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            // Default: Top Center
            let top = rect.top - tooltipRect.height - 8;
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

            // Prevent going off top of screen
            if (top < 10) {
                // Flip to bottom
                top = rect.bottom + 8;
            }

            // Prevent going off left edge
            if (left < 10) left = 10;
            
            // Prevent going off right edge
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }

        function switchView(view) {
            document.getElementById('view-viewer').classList.toggle('hidden', view !== 'viewer');
            document.getElementById('view-compare').classList.toggle('hidden', view !== 'compare');
            
            const btnV = document.getElementById('btn-viewer');
            const btnC = document.getElementById('btn-compare');
            
            const activeClass = "px-4 py-1.5 rounded shadow-sm bg-white text-slate-800 font-bold border border-slate-200 transition-all";
            const inactiveClass = "px-4 py-1.5 rounded text-slate-500 hover:text-slate-800 hover:bg-slate-100 transition-all";

            if (view === 'viewer') {
                btnV.className = activeClass;
                btnC.className = inactiveClass;
            } else {
                btnC.className = activeClass;
                btnV.className = inactiveClass;
            }
        }

        function processText(text, glossary) {
            if (!text) return "";
            const keys = Object.keys(glossary).sort((a, b) => b.length - a.length);
            let html = text;
            const map = {};
            let idx = 0;

            keys.forEach(k => {
                const safeKey = escapeRegExp(k);
                const regex = new RegExp(`\\b(${safeKey})\\b`, 'gi');
                if (html.match(regex)) {
                    html = html.replace(regex, (match) => {
                        const id = `___G${idx++}___`;
                        map[id] = { term: match, def: glossary[k] };
                        return id;
                    });
                }
            });

            Object.keys(map).forEach(id => {
                const { term, def } = map[id];
                const safeDef = def.replace(/"/g, '&quot;');
                html = html.replace(id, `<span class="glossary-term" data-definition="${safeDef}">${term}</span>`);
            });

            return html;
        }

        function renderTabs() {
            const el = document.getElementById('level-tabs');
            el.innerHTML = LEVELS.map(l => {
                const active = l === currentLevel;
                const style = active ? "bg-slate-800 text-white border-slate-800" : "bg-white text-slate-500 border-slate-200 hover:bg-slate-50";
                return `<button onclick="changeLevel('${l}')" class="${style} border px-3 py-1 text-[11px] font-bold rounded transition-colors">${l}</button>`;
            }).join('');
        }

        function changeLevel(l) {
            currentLevel = l;
            renderTabs();
            renderRubric(l);
        }

        function renderRubric(lvl) {
            const data = DB[lvl];
            const cols = data.subscales;
            let h = `<table class="rubric-table border-collapse text-left">`;
            h += `<thead class="bg-slate-50 border-b border-slate-200 sticky top-0 z-10"><tr>`;
            h += `<th class="p-3 w-12 text-center text-[10px] font-bold text-slate-500 uppercase bg-slate-50">Band</th>`;
            cols.forEach(c => h += `<th class="p-3 text-[10px] font-bold text-slate-500 uppercase bg-slate-50 border-l border-slate-200">${c}</th>`);
            h += `</tr></thead><tbody>`;

            [5, 4, 3, 2, 1, 0].forEach(b => {
                const isEven = b % 2 === 0 && b !== 0;
                const isZero = b === 0;
                const bg = b % 2 === 0 ? "bg-slate-50/50" : "bg-white";
                h += `<tr class="${bg} border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors">`;
                h += `<td class="p-3 text-center font-bold text-slate-700 text-sm align-top border-r border-slate-200">${b}</td>`;
                
                if (isZero) {
                    h += `<td colspan="${cols.length}" class="p-3 text-slate-400 italic align-top">Content is totally irrelevant. Target reader is not informed. Performance below Band 1.</td>`;
                } else if (isEven) {
                    cols.forEach(c => h += `<td class="p-3 text-slate-400 italic align-top border-r border-slate-100 last:border-0 leading-relaxed">Performance shares features of Bands ${b-1} and ${b+1}.</td>`);
                } else {
                    cols.forEach(c => {
                        const raw = data.bands[b][c] || "";
                        h += `<td class="p-3 text-slate-800 align-top border-r border-slate-100 last:border-0 leading-relaxed">${processText(raw, data.glossary)}</td>`;
                    });
                }
                h += `</tr>`;
            });
            h += `</tbody></table>`;
            document.getElementById('rubric-display').innerHTML = h;
        }

        function renderComparatorControls() {
            document.getElementById('compare-level-checks').innerHTML = LEVELS.map(l => {
                const checked = (l === 'B2' || l === 'C1') ? 'checked' : '';
                const s = LEVEL_STYLES[l];
                return `<label class="cursor-pointer select-none">
                    <input type="checkbox" value="${l}" ${checked} class="peer sr-only" onchange="runComparison()">
                    <span class="block px-3 py-0.5 rounded border text-[10px] font-bold ${s.bg} border-slate-200 ${s.text} opacity-50 peer-checked:opacity-100 peer-checked:ring-1 peer-checked:ring-offset-0 ring-current transition-all">${l}</span>
                </label>`;
            }).join('');

            const allSubscales = new Set();
            Object.values(DB).forEach(d => d.subscales.forEach(s => allSubscales.add(s.toUpperCase())));
            
            document.getElementById('compare-subscale-checks').innerHTML = Array.from(allSubscales).map((s, i) => {
                const display = s.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); 
                const checked = i === 3 ? 'checked' : '';
                return `<label class="cursor-pointer select-none">
                    <input type="checkbox" value="${s}" ${checked} class="peer sr-only" onchange="runComparison()">
                    <span class="block px-3 py-0.5 rounded border border-slate-200 bg-white text-slate-500 text-[10px] hover:border-slate-300 peer-checked:bg-slate-700 peer-checked:text-white peer-checked:border-slate-700 transition-all">${display}</span>
                </label>`;
            }).join('');
        }

        function runComparison() {
            const lvls = Array.from(document.querySelectorAll('#compare-level-checks input:checked')).map(i => i.value);
            const subsUpper = Array.from(document.querySelectorAll('#compare-subscale-checks input:checked')).map(i => i.value);
            const div = document.getElementById('comparison-result');

            if (!lvls.length || !subsUpper.length) {
                div.innerHTML = `<div class="p-8 text-center text-slate-400 italic">Select levels and subscales.</div>`;
                return;
            }

            let h = `<table class="rubric-table border-collapse bg-white shadow-sm rounded-lg overflow-hidden">`;
            h += `<thead><tr class="text-white">`;
            h += `<th class="w-12 bg-slate-800 border-r border-slate-700 sticky top-0 z-20"></th>`;
            lvls.forEach(l => h += `<th colspan="${subsUpper.length}" class="${LEVEL_STYLES[l].header} p-2 text-[10px] font-bold uppercase tracking-wider text-center border-l border-white/20 sticky top-0 z-20">${l}</th>`);
            h += `</tr>`;

            h += `<tr class="bg-slate-100 border-b border-slate-200">`;
            h += `<th class="p-2 text-[10px] font-bold text-slate-500 bg-slate-100 sticky top-8 z-20 border-r border-slate-200">Band</th>`;
            lvls.forEach(l => {
                subsUpper.forEach(sUp => {
                    const actualKey = DB[l].subscales.find(k => k.toUpperCase() === sUp);
                    const label = sUp.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                    const opacity = actualKey ? "opacity-100" : "opacity-40";
                    h += `<th class="p-2 text-[10px] font-bold text-slate-600 bg-slate-100 uppercase border-l border-slate-200 sticky top-8 z-20 ${opacity}">${label}</th>`;
                });
            });
            h += `</tr></thead><tbody>`;

            [5, 3, 1].forEach(b => {
                h += `<tr class="border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors">`;
                h += `<td class="p-3 text-center font-bold text-slate-700 bg-slate-50 text-sm align-top border-r border-slate-200 sticky left-0 z-10">${b}</td>`;
                lvls.forEach(l => {
                    subsUpper.forEach(sUp => {
                        const actualKey = DB[l].subscales.find(k => k.toUpperCase() === sUp);
                        if (!actualKey) h += `<td class="bg-slate-50/50 border-r border-slate-200"></td>`;
                        else {
                            const raw = DB[l].bands[b][actualKey] || "";
                            h += `<td class="p-2 text-[11px] leading-relaxed text-slate-800 border-r border-slate-100 align-top relative group">
                                <div class="absolute inset-0 ${LEVEL_STYLES[l].bg} opacity-0 group-hover:opacity-30 pointer-events-none transition-opacity"></div>
                                ${processText(raw, DB[l].glossary)}
                            </td>`;
                        }
                    });
                });
                h += `</tr>`;
            });
            h += `</tbody></table>`;
            div.innerHTML = h;
        }

        function copyCurrentRubric() {
            const data = DB[currentLevel];
            let md = `# ${currentLevel}\n\n`;
            [5,4,3,2,1,0].forEach(b => {
                md += `## Band ${b}\n`;
                if(b===0) md += "Content irrelevant.\n";
                else if(b%2===0) md += "Shares features.\n";
                else data.subscales.forEach(s => md += `**${s}**: ${data.bands[b][s]}\n\n`);
            });
            navigator.clipboard.writeText(md).then(() => {
                const t = document.getElementById('toast');
                t.classList.remove('opacity-0', 'translate-y-2');
                setTimeout(() => t.classList.add('opacity-0', 'translate-y-2'), 2500);
            });
        }

        init();
    </script>
</body>
</html>
